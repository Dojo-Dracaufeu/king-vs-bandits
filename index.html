<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>King vs Bandits</title>
  <div id="game-container" style="flex-wrap: wrap;">
  <style>
    :root {
      --card-red: #e74c3c;
      --card-black: #2c3e50;
      --card-back: #3498db;
      --wood-light: #e2c08d;
      --wood-dark: #c19a6b;
      --felt-green: #2e8b57;
      --gold: #f1c40f;
      --royal-purple: #9b59b6;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--wood-light);
      background-image: linear-gradient(
        to bottom,
        var(--wood-light),
        var(--wood-dark)
      );
      color: #333;
      height: 100vh;
      width: 100vw;
      overflow: hidden;
      touch-action: manipulation;
      position: fixed;
    }
    
    #game-container {
      display: flex;
      flex-direction: column;
      height: 100%;
      width: 100%;
      max-width: 100%;
      padding: 10px;
    }
    
    h1 {
      text-align: center;
      color: white;
      margin: 5px 0;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
      font-size: 1.5rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    #players-area {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 8px;
      perspective: 1000px;
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      padding: 5px;
      align-content: flex-start;
    }
    
    .player {
      position: relative;
      border-radius: 10px;
      padding: 12px;
      width: calc(50% - 10px);
      max-width: 160px;
      text-align: center;
      background-color: rgba(255,255,255,0.1);
      backdrop-filter: blur(5px);
      border: 1px solid rgba(255,255,255,0.2);
      box-shadow: 0 4px 10px rgba(0,0,0,0.15);
      transition: all 0.3s ease;
      min-height: 180px;
    }
    
    @media (max-width: 400px) {
      .player {
        width: calc(100% - 10px);
        max-width: none;
      }
    }
    
    .player.current {
      background-color: rgba(52, 152, 219, 0.2);
      box-shadow: 0 0 15px rgba(52, 152, 219, 0.6);
      transform: translateY(-3px);
    }
    
    .player.king {
      background: linear-gradient(135deg, rgba(241, 196, 15, 0.3), rgba(155, 89, 182, 0.3));
      border: 2px solid var(--gold);
      box-shadow: 0 0 15px var(--gold), 
                  0 0 10px var(--royal-purple),
                  inset 0 0 10px rgba(255,215,0,0.5);
      position: relative;
      overflow: hidden;
    }
    
    .player.king::before {
      content: "ðŸ‘‘";
      position: absolute;
      top: 5px;
      right: 5px;
      font-size: 1.2rem;
      filter: drop-shadow(0 0 2px black);
    }
    
    .player.king .player-name {
      color: var(--gold);
      text-shadow: 0 0 3px black, 
                   0 0 5px var(--royal-purple);
      font-weight: bold;
    }
    
    .player-name {
      font-weight: 600;
      margin-bottom: 8px;
      color: white;
      font-size: 1rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    .player-role {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.8);
      margin-bottom: 10px;
      min-height: 18px;
      font-weight: 500;
      text-shadow: 1px 1px 1px rgba(0,0,0,0.3);
    }
    
    .card-container {
      position: relative;
      width: 60px;
      height: 90px;
      margin: 0 auto;
      margin-bottom: 10px;
      transform-style: preserve-3d;
      transition: transform 0.5s;
    }
    
    .card-face {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 6px;
      backface-visibility: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }
    
    .card-front {
      background-color: white;
      transform: rotateY(180deg);
      font-weight: bold;
      font-size: 1.5rem;
      color: var(--card-black);
      border: 1px solid #eee;
    }
    
    .card-front.red {
      color: var(--card-red);
    }
    
    .card-back {
      background-color: var(--card-back);
      background-image: 
        radial-gradient(circle at center, white 0%, white 10%, transparent 10.1%),
        radial-gradient(circle at center, white 0%, white 10%, transparent 10.1%);
      background-size: 15px 15px;
      background-position: 0 0, 7px 7px;
      border: 2px solid white;
    }
    
    .card-value {
      font-size: 1.5rem;
    }
    
    .card-suit {
      font-size: 1rem;
      position: absolute;
      bottom: 3px;
      right: 3px;
    }
    
    #controls-area {
      background-color: var(--felt-green);
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.2);
      margin: 8px 0;
      border: 2px solid rgba(255,255,255,0.3);
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    
    button {
      padding: 10px 15px;
      margin: 0;
      cursor: pointer;
      background-color: rgba(255,255,255,0.9);
      color: #2c3e50;
      border: none;
      border-radius: 6px;
      font-size: 0.9rem;
      transition: all 0.2s;
      font-weight: 600;
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
      flex: 1;
      min-width: 120px;
      max-width: 160px;
    }
    
    button:hover {
      background-color: white;
      transform: translateY(-1px);
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }
    
    button:active {
      transform: translateY(1px);
    }
    
    button:disabled {
      background-color: rgba(255,255,255,0.4);
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }
    
    .used-ability {
      opacity: 0.7;
      position: relative;
    }
    
    .used-ability::after {
      content: "";
      position: absolute;
      top: 50%;
      left: 5px;
      right: 5px;
      height: 2px;
      background-color: #e74c3c;
      transform: translateY(-50%);
    }
    
    #log-area {
      border: 2px solid rgba(255,255,255,0.2);
      padding: 10px;
      flex: 0 0 100px;
      overflow-y: auto;
      background-color: rgba(0,0,0,0.2);
      border-radius: 8px;
      box-shadow: inset 0 2px 8px rgba(0,0,0,0.2);
      font-size: 0.85rem;
      line-height: 1.4;
    }
    
    .log-entry {
      margin-bottom: 8px;
      padding: 8px;
      border-radius: 4px;
      background-color: rgba(255,255,255,0.1);
      border-left: 3px solid #3498db;
      color: white;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(-8px); }
      to { opacity: 1; transform: translateX(0); }
    }
    
    .log-entry.system {
      border-left-color: #bdc3c7;
    }
    
    .log-entry.action {
      border-left-color: #2ecc71;
      background-color: rgba(46, 204, 113, 0.1);
    }
    
    .log-entry.special {
      border-left-color: var(--gold);
      background-color: rgba(241, 196, 15, 0.1);
    }
    
    #action-area {
      display: none;
      background-color: rgba(0,0,0,0.3);
      padding: 12px;
      border-radius: 8px;
      margin: 8px 0;
    }
    
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      justify-content: center;
    }
    
    .player-btn {
      padding: 8px 12px;
      background-color: rgba(46, 204, 113, 0.9);
      color: white;
      flex: 1;
      min-width: 100px;
    }
    
    .player-btn:hover {
      background-color: rgba(39, 174, 96, 0.9);
    }
    
    .peek-notification {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      z-index: 100;
      text-align: center;
      width: 90%;
      max-width: 300px;
      border: 3px solid var(--gold);
      animation: popIn 0.3s ease;
    }
    
    @keyframes popIn {
      0% { transform: translate(-50%, -50%) scale(0.9); opacity: 0; }
      100% { transform: translate(-50%, -50%) scale(1); opacity: 1; }
    }
    
    .peek-notification h3 {
      margin-top: 0;
      color: #2c3e50;
      border-bottom: 2px solid var(--gold);
      padding-bottom: 8px;
      font-size: 1.2rem;
    }
    
    .peek-notification p {
      font-size: 1rem;
      margin: 15px 0;
      color: #2c3e50;
    }
    
    .peek-notification button {
      background-color: var(--gold);
      color: #2c3e50;
      font-weight: bold;
      padding: 8px 20px;
      margin-top: 10px;
    }
    
    .peek-notification button:hover {
      background-color: #f39c12;
    }
    
    .card-corner {
      position: absolute;
      font-size: 0.7rem;
      font-weight: bold;
    }
    
    .card-corner.top-left {
      top: 3px;
      left: 3px;
    }
    
    .card-corner.bottom-right {
      bottom: 3px;
      right: 3px;
      transform: rotate(180deg);
    }
    
    .deck-count {
      position: absolute;
      top: 15px;
      right: 15px;
      color: white;
      font-size: 0.8rem;
      text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
      background: rgba(0,0,0,0.3);
      padding: 3px 8px;
      border-radius: 10px;
    }
    
    .instructions-btn {
      position: absolute;
      top: 15px;
      left: 15px;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      background-color: rgba(255,255,255,0.9);
      color: #2c3e50;
      border: none;
      font-weight: bold;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
    
    .instructions-panel {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background-color: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
      z-index: 100;
      width: 90%;
      max-width: 400px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .instructions-panel h3 {
      color: #2c3e50;
      margin-bottom: 15px;
    }
    
    .instructions-panel p {
      margin-bottom: 10px;
      color: #2c3e50;
      font-size: 0.9rem;
      line-height: 1.5;
    }
    
    .instructions-panel button {
      margin-top: 15px;
    }
    
    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: rgba(0,0,0,0.5);
      z-index: 99;
    }
  
#extra-controls {
  position: absolute;
  top: 10px;
  right: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
  z-index: 20;
}

#extra-controls button {
  background-color: rgba(255, 255, 255, 0.95);
  border: 2px solid #2c3e50;
  border-radius: 8px;
  font-size: 0.8rem;
  padding: 8px 10px;
  font-weight: bold;
  color: #2c3e50;
  min-width: 100px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.2);
}

@media (orientation: landscape) and (max-height: 500px) {
  body {
    overflow: hidden;
  }

  #players-area {
    flex-wrap: nowrap;
    overflow-x: auto;
    overflow-y: hidden;
  }
}

</style>
</head>
<body>
  <div id="game-container">
    <button class="instructions-btn" id="instructionsBtn">?</button>
    <h1>King vs Bandits</h1>
    <div class="deck-count" id="deckCount"></div>
<div id="extra-controls">
  <button id="manualEndGameBtn" disabled>End Game</button>
  <button id="restartBtn" disabled>Restart Game</button>
</div>

    
    <div id="players-area"></div>
    
    <div id="controls-area">
      <button id="startBtn">Start Game</button>
      <button id="startTurnBtn" disabled>Start Turn</button>
      <button id="endTurnBtn" disabled>End Turn</button>
      
    </div>
    
    <div id="action-area"></div>
    
    <div id="log-area"></div>
  </div>
  
  <script>
    // Game state with K as highest (12) and A as lowest (0)
    const values = ["A", "2", "3", "4", "5", "6", "7", "8", "9", "10", "J", "Q", "K"];
    const suits = ["â™ ", "â™¥", "â™¦", "â™£"];
    let deck = [];
    let players = [];
    let currentPlayerIndex = 0;
    let gameStarted = false;
    let gameEnded = false;
    let currentPlayer;
    let kingHasPeeked = false;
    let bigBrotherHasSwapped = false;
    let turnActive = false;
    let consecutivePasses = 0;
    let actionTaken = false;
    let swapInProgress = false;

    // DOM elements
    const startBtn = document.getElementById("startBtn");
    const startTurnBtn = document.getElementById("startTurnBtn");
    const endTurnBtn = document.getElementById("endTurnBtn");
    const playersArea = document.getElementById("players-area");
    const actionArea = document.getElementById("action-area");
    const logArea = document.getElementById("log-area");
    const deckCount = document.getElementById("deckCount");
    const instructionsBtn = document.getElementById("instructionsBtn");

    // Initialize game
    startBtn.addEventListener("click", startGame);
    startTurnBtn.addEventListener("click", startPlayerTurn);
    endTurnBtn.addEventListener("click", () => {
      if (!actionTaken) {
        currentPlayer.passed = true;
        currentPlayer.hasTakenAction = true;
        addToLog(currentPlayer.name + " passed", "action");
      }
      endPlayerTurn();
    });
    
    instructionsBtn.addEventListener("click", showInstructions);

const manualEndGameBtn = document.getElementById("manualEndGameBtn");
const restartBtn = document.getElementById("restartBtn");

manualEndGameBtn.addEventListener("click", () => {
  endGame("Game manually ended by user.");
});

restartBtn.addEventListener("click", () => {
  location.reload();
});


    function startGame() {
      // Reset game state
      gameStarted = true;
      gameEnded = false;
      kingHasPeeked = false;
      bigBrotherHasSwapped = false;
      consecutivePasses = 0;
      startBtn.disabled = true;
  manualEndGameBtn.disabled = false;
  restartBtn.disabled = false;
      logArea.innerHTML = "";
      startTurnBtn.disabled = false;
      endTurnBtn.disabled = true;
      actionArea.style.display = "none";
      
      // Create and shuffle deck
      deck = [];
      for (let i = 0; i < values.length; i++) {
        for (let j = 0; j < 4; j++) {
          const isRed = j === 1 || j === 2;
          deck.push({ 
            value: values[i], 
            numericValue: i,
            suit: suits[j],
            isRed: isRed
          });
        }
      }
      deck = deck.concat(deck, deck).slice(0, 52);
      deck = shuffleArray(deck);
      
      // Assign roles
      const roles = [
        { name: "King", team: "good", isKing: true },
        { name: "Guard", team: "good" },
        { name: "Guard", team: "good" },
        { name: "Big Bandit", team: "evil", isBigBandit: true },
        { name: "Small Bandit", team: "evil" }
      ];
      
      players = shuffleArray(roles).map((role, index) => ({
        id: index + 1,
        name: `Player ${index + 1}`,
        role: role.name,
        team: role.team,
        isKing: role.isKing || false,
        isBigBandit: role.isBigBandit || false,
        card: deck.pop(),
        hasSwapped: false,
        hasDrawn: false,
        passed: false,
        isRevealed: false,
        cardVisible: false,
        hasTakenAction: false
      }));
      
      // Reveal King's identity
      const king = players.find(p => p.isKing);
      king.isRevealed = true;
      
      // Start with player after King
      const kingIndex = players.indexOf(king);
      currentPlayerIndex = (kingIndex + 1) % 5;
      
      updateDeckCount();
      addToLog("Game started! The King is " + king.name, "system");
      renderGame();
      updateTurnIndicator();
    }

    function startPlayerTurn() {
      turnActive = true;
      actionTaken = false;
      swapInProgress = false;
      currentPlayer = players[currentPlayerIndex];
      
      // Reset passed status for new turn
      currentPlayer.passed = false;
      
      // Reveal current player's identity to themselves
      currentPlayer.isRevealed = true;
      currentPlayer.cardVisible = true;
      
      startTurnBtn.disabled = true;
      endTurnBtn.disabled = false;
      
      addToLog(currentPlayer.name + "'s turn", "system");
      renderGame();
      
      showTurnActions();
    }

    function endPlayerTurn() {
      turnActive = false;
      swapInProgress = false;
      
      // Hide current player's identity and card (except King's identity)
      if (!currentPlayer.isKing) {
        currentPlayer.isRevealed = false;
      }
      currentPlayer.cardVisible = false;
      
      startTurnBtn.disabled = true;
      endTurnBtn.disabled = true;
      actionArea.style.display = "none";
      actionArea.innerHTML = "";
      
      // Track consecutive passes
      if (currentPlayer.passed) {
        consecutivePasses++;
      } else {
        consecutivePasses = 0; // Reset if someone took an action
      }
      
      // Check if King was last to pass/act
      const king = players.find(p => p.isKing);
      const kingIndex = players.indexOf(king);
      const lastPlayerIndex = (currentPlayerIndex - 1 + 5) % 5;
      
      // Second win condition: All passed consecutively ending with King
      if (consecutivePasses >= 5 && lastPlayerIndex === kingIndex) {
        endGame("Game ended - all players passed consecutively ending with King");
        return;
      }
      
      // Check if all players have acted this round
      const allDone = players.every(p => p.passed || p.hasTakenAction);
      
      if (allDone) {
        // Reset for new round
        players.forEach(p => {
          p.passed = false;
          p.hasTakenAction = false;
        });
        consecutivePasses = 0;
      }
      
      // Check if all actions are used
      if (checkGameEnd()) {
        return;
      }
      
      // Move to next player
      currentPlayerIndex = (currentPlayerIndex + 1) % 5;
      
      renderGame();
      updateTurnIndicator();
      
      // Enable Start Turn for next player
      startTurnBtn.disabled = false;
    }

    function checkGameEnd() {
      const allActionsUsed = players.every(p => 
        (p.hasSwapped && p.hasDrawn) && 
        (!p.isKing || kingHasPeeked) &&
        (!p.isBigBandit || bigBrotherHasSwapped)
      );
      
      if (allActionsUsed) {
        endGame("Game ended - all actions have been used");
        return true;
      }
      
      return false;
    }

    function showTurnActions() {
      actionArea.style.display = "block";
      actionArea.innerHTML = "<p style='color:white; text-align:center; margin-bottom:8px;'>Choose an action:</p>";
      
      const buttonsContainer = document.createElement("div");
      buttonsContainer.className = "action-buttons";
      
      // Pass button
      const passBtn = document.createElement("button");
      passBtn.textContent = "Pass";
      passBtn.addEventListener("click", () => {
        if (!actionTaken) {
          actionTaken = true;
          currentPlayer.passed = true;
          currentPlayer.hasTakenAction = true;
          addToLog(currentPlayer.name + " passed", "action");
          disableAllActions();
          endPlayerTurn();
        }
      });
      buttonsContainer.appendChild(passBtn);
      
      // Swap button if not used this game
      if (!currentPlayer.hasSwapped) {
        const swapBtn = document.createElement("button");
        swapBtn.textContent = "Swap with player";
        swapBtn.addEventListener("click", () => {
          if (!actionTaken) {
            actionTaken = true;
            currentPlayer.hasTakenAction = true;
            showPlayerSelection("swap");
          }
        });
        buttonsContainer.appendChild(swapBtn);
      }
      
      // Draw button if not used this game
      if (!currentPlayer.hasDrawn) {
        const drawBtn = document.createElement("button");
        drawBtn.textContent = "Draw new card";
        drawBtn.addEventListener("click", () => {
          if (!actionTaken) {
            actionTaken = true;
            currentPlayer.hasTakenAction = true;
            currentPlayer.card = deck.pop();
            currentPlayer.hasDrawn = true;
            updateDeckCount();
            addToLog(currentPlayer.name + " drew a new card", "action");
            renderGame();
            disableAllActions();
          }
        });
        buttonsContainer.appendChild(drawBtn);
      }
      
      // King's peek ability
      if (currentPlayer.isKing && !kingHasPeeked) {
        const peekBtn = document.createElement("button");
        peekBtn.textContent = "Peek at player";
        peekBtn.addEventListener("click", () => {
          if (!actionTaken) {
            actionTaken = true;
            currentPlayer.hasTakenAction = true;
            kingHasPeeked = true;
            showPlayerSelection("peek");
          }
        });
        buttonsContainer.appendChild(peekBtn);
      }
      
      // Big Bandit's swap ability
      if (currentPlayer.isBigBandit && !bigBrotherHasSwapped) {
        const swapBtn = document.createElement("button");
        swapBtn.textContent = "Swap two players";
        swapBtn.addEventListener("click", () => {
          if (!actionTaken) {
            actionTaken = true;
            currentPlayer.hasTakenAction = true;
            bigBrotherHasSwapped = true;
            showDoublePlayerSelection();
          }
        });
        buttonsContainer.appendChild(swapBtn);
      }
      
      actionArea.appendChild(buttonsContainer);
    }

    function disableAllActions() {
      const buttons = actionArea.querySelectorAll("button");
      buttons.forEach(btn => {
        btn.disabled = true;
      });
    }

    function updateTurnIndicator() {
      const playerElements = playersArea.querySelectorAll(".player");
      
      playerElements.forEach((el, index) => {
        el.classList.remove("current");
        if (index === currentPlayerIndex) {
          el.classList.add("current");
        }
      });
    }

    function showPlayerSelection(action) {
      actionArea.innerHTML = "<p style='color:white; text-align:center; margin-bottom:8px;'>Select a player:</p>";
      
      const buttonsContainer = document.createElement("div");
      buttonsContainer.className = "action-buttons";
      
      players.forEach(player => {
        if (player.id !== currentPlayer.id) {
          const btn = document.createElement("button");
          btn.textContent = player.name;
          btn.className = "player-btn";
          btn.addEventListener("click", () => {
            if (action === "swap") {
              // Swap cards
              const temp = currentPlayer.card;
              currentPlayer.card = player.card;
              player.card = temp;
              currentPlayer.hasSwapped = true;
              addToLog(`${currentPlayer.name} swapped cards with ${player.name}`, "action");
            } else if (action === "peek") {
              // Peek at card (only show to King, not in log)
              showPeekNotification(player);
              return;
            }
            renderGame();
            disableAllActions();
          });
          buttonsContainer.appendChild(btn);
        }
      });
      
      actionArea.appendChild(buttonsContainer);
    }

    function showPeekNotification(player) {
      const overlay = document.createElement("div");
      overlay.className = "overlay";
      
      const notification = document.createElement("div");
      notification.className = "peek-notification";
      notification.innerHTML = `
        <h3>Peek Result</h3>
        <div class="card-container" style="transform: rotateY(180deg); margin:15px auto;">
          <div class="card-face card-front ${player.card.isRed ? 'red' : ''}">
            <div class="card-corner top-left">${player.card.value}${player.card.suit}</div>
            <div class="card-value">${player.card.value}</div>
            <div class="card-suit">${player.card.suit}</div>
            <div class="card-corner bottom-right">${player.card.value}${player.card.suit}</div>
          </div>
        </div>
        <p>${player.name}'s card is: <strong>${player.card.value}</strong></p>
        <button id="closePeek">OK</button>
      `;
      
      document.body.appendChild(overlay);
      document.body.appendChild(notification);
      
      document.getElementById("closePeek").addEventListener("click", () => {
        document.body.removeChild(overlay);
        document.body.removeChild(notification);
        addToLog(`${currentPlayer.name} peeked at ${player.name}'s card`, "special");
        renderGame();
        disableAllActions();
      });
    }

    function showDoublePlayerSelection() {
      actionArea.innerHTML = "<p style='color:white; text-align:center; margin-bottom:8px;'>Select two players to swap:</p>";
      
      const buttonsContainer = document.createElement("div");
      buttonsContainer.className = "action-buttons";
      
      const selectedPlayers = [];
      const playerButtons = [];
      
      // Big Bandit can swap any two players (including King)
      players.forEach(player => {
        const btn = document.createElement("button");
        btn.textContent = player.name;
        btn.className = "player-btn";
        btn.addEventListener("click", () => {
          if (selectedPlayers.includes(player.id)) {
            // Deselect
            const index = selectedPlayers.indexOf(player.id);
            selectedPlayers.splice(index, 1);
            btn.style.backgroundColor = "";
          } else if (selectedPlayers.length < 2) {
            // Select
            selectedPlayers.push(player.id);
            btn.style.backgroundColor = "#3498db";
          }
          
          if (selectedPlayers.length === 2) {
            // Perform swap
            const player1 = players.find(p => p.id === selectedPlayers[0]);
            const player2 = players.find(p => p.id === selectedPlayers[1]);
            
            const temp = player1.card;
            player1.card = player2.card;
            player2.card = temp;
            
            addToLog(`${currentPlayer.name} swapped ${player1.name}'s and ${player2.name}'s cards`, "action");
            renderGame();
            disableAllActions();
          }
        });
        buttonsContainer.appendChild(btn);
        playerButtons.push(btn);
      });
      
      actionArea.appendChild(buttonsContainer);
    }

    function renderGame() {
      playersArea.innerHTML = "";
      
      players.forEach(player => {
        const playerEl = document.createElement("div");
        playerEl.className = `player ${player.isKing ? "king" : ""}`;
        if (player.id === currentPlayer?.id) {
          playerEl.classList.add("current");
        }
        
        const nameEl = document.createElement("div");
        nameEl.className = "player-name";
        nameEl.textContent = player.name;
        playerEl.appendChild(nameEl);
        
        const roleEl = document.createElement("div");
        roleEl.className = "player-role";
        roleEl.textContent = player.isRevealed ? player.role : "?";
        playerEl.appendChild(roleEl);
        
        const cardContainer = document.createElement("div");
        cardContainer.className = "card-container";
        cardContainer.style.transform = player.cardVisible ? "rotateY(180deg)" : "";
        
        const cardFront = document.createElement("div");
        cardFront.className = `card-face card-front ${player.card.isRed ? 'red' : ''}`;
        
        const cardCornerTL = document.createElement("div");
        cardCornerTL.className = "card-corner top-left";
        cardCornerTL.textContent = `${player.card.value}${player.card.suit}`;
        cardFront.appendChild(cardCornerTL);
        
        const cardValue = document.createElement("div");
        cardValue.className = "card-value";
        cardValue.textContent = player.card.value;
        cardFront.appendChild(cardValue);
        
        const cardSuit = document.createElement("div");
        cardSuit.className = "card-suit";
        cardSuit.textContent = player.card.suit;
        cardFront.appendChild(cardSuit);
        
        const cardCornerBR = document.createElement("div");
        cardCornerBR.className = "card-corner bottom-right";
        cardCornerBR.textContent = `${player.card.value}${player.card.suit}`;
        cardFront.appendChild(cardCornerBR);
        
        const cardBack = document.createElement("div");
        cardBack.className = "card-face card-back";
        
        cardContainer.appendChild(cardFront);
        cardContainer.appendChild(cardBack);
        playerEl.appendChild(cardContainer);
        
        playersArea.appendChild(playerEl);
      });
    }

    function addToLog(message, type = "system") {
      const entry = document.createElement("div");
      entry.className = `log-entry ${type}`;
      entry.textContent = message;
      logArea.appendChild(entry);
      logArea.scrollTop = logArea.scrollHeight;
    }

    function updateDeckCount() {
      deckCount.textContent = `Deck: ${deck.length}`;
    }

    function shuffleArray(array) {
      const newArray = [...array];
      for (let i = newArray.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
      }
      return newArray;
    }

    function endGame(message) {
      gameEnded = true;
      addToLog(message, "system");
      
      // Reveal all players and cards at game end
      players.forEach(player => {
        player.isRevealed = true;
        player.cardVisible = true;
      });
      renderGame();
      
      // Determine winner by comparing only King vs Bandits
      const king = players.find(p => p.isKing);
      const bandits = players.filter(p => p.team === "evil");
      
      let kingWins = true;
      for (const bandit of bandits) {
        if (bandit.card.numericValue >= king.card.numericValue) {
          kingWins = false;
          break;
        }
      }
      
      if (kingWins) {
        addToLog(`The King has ${king.card.value} and all Bandits have lower cards! Good team wins!`, "special");
      } else {
        addToLog(`At least one Bandit has a card equal or higher than the King's ${king.card.value}! Evil team wins!`, "special");
      }
      
      startBtn.disabled = false;
      startTurnBtn.disabled = true;
      endTurnBtn.disabled = true;
    }
    
    function showInstructions() {
      const overlay = document.createElement("div");
      overlay.className = "overlay";
      
      const panel = document.createElement("div");
      panel.className = "instructions-panel";
      panel.innerHTML = `
        <h3>How to Play King vs Bandits</h3>
        <p><strong>Objective:</strong> The King and Guards (good team) try to end with the King having a higher card than all Bandits (K is highest, A is lowest). Bandits (evil team) try to prevent this.</p>
        <p><strong>Gameplay:</strong> Players take turns performing actions. The King is revealed at the start.</p>
        <p><strong>Actions:</strong>
        <ul style="margin-left:20px; margin-top:5px;">
          <li><strong>Pass:</strong> End your turn without acting</li>
          <li><strong>Swap:</strong> Trade cards with another player</li>
          <li><strong>Draw:</strong> Replace your card with a new one</li>
        </ul>
        </p>
        <p><strong>Special Abilities:</strong>
        <ul style="margin-left:20px; margin-top:5px;">
          <li><strong>King:</strong> Can peek at another player's card</li>
          <li><strong>Big Bandit:</strong> Can swap any two players' cards</li>
        </ul>
        </p>
        <p><strong>Winning:</strong> At game end, only the King's card is compared against Bandits' cards. Guards' cards don't matter.</p>
        <button id="closeInstructions">Got It!</button>
      `;
      
      document.body.appendChild(overlay);
      document.body.appendChild(panel);
      
      document.getElementById("closeInstructions").addEventListener("click", () => {
        document.body.removeChild(overlay);
        document.body.removeChild(panel);
      });
    }
  </script>
</body>
</html>
